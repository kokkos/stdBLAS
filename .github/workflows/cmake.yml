name: CMake

on: [push, pull_request]

env:
  CXX: g++-10 # Note: need GCC v10 (or newer) to avoid TBB compilation errors
  CC: gcc-10  # Note: g++-11 fails with "sorry, unimplemented: unexpected AST of kind nontype_argument_pack"
  CXX_STANDARD: 17
  KOKKOS_VERSION: 3.6.00 # develop
  KK_VERSION: 3.6.00 # develop
  SHARED_LIBS: ON

jobs:
  stdblas:
    name: Test stdBLAS
    runs-on: ubuntu-latest
    defaults:
      run:
        shell: bash

    strategy:
      matrix:
        implementation: [Native, Kokkos]
        cmake_build_type: [Release, Debug] # RelWithDebInfo

    env:
      BUILD_TYPE: ${{ matrix.cmake_build_type }}
      INSTALL_PATH: ${{ github.workspace }}/install
      UTILS_PATH: ${{ github.workspace }}/src/stdblas/.github/workflows/utils
      KOKKOS_BACKEND: Serial # TODO: ${{ matrix.kokkos_backend }} ?
        # FIXME OpenMP fails tests with: "Kokkos::OpenMP parallel_reduce ERROR: in parallel or not initialized"
        # FIXME Threads fails tests with: "ThreadsExec::start FAILED : Threads not initialized."

    steps:

      - name: Check out stdBLAS
        uses: actions/checkout@v2
        with:
          path: src/stdblas

      - name: Check out mdspan
        uses: actions/checkout@v2
        with:
          repository: kokkos/mdspan
          path: src/mdspan

      - name: Build and install mdspan
        run: $UTILS_PATH/build_mdspan.sh

      - name: Check out Kokkos
        if: matrix.implementation == 'Kokkos'
        uses: actions/checkout@v2
        with:
          repository: kokkos/kokkos
          path: src/kokkos
          ref: ${{ env.KOKKOS_VERSION }}

      - name: Build and install Kokkos
        if: matrix.implementation == 'Kokkos'
        run: $UTILS_PATH/build_kokkos.sh

      - name: Check out Kokkos-Kernels
        if: matrix.implementation == 'Kokkos'
        uses: actions/checkout@v2
        with:
          repository: kokkos/kokkos-kernels
          path: src/kokkos-kernels
          ref: ${{ env.KK_VERSION }}

      - name: Build and install Kokkos-Kernels
        if: matrix.implementation == 'Kokkos'
        run: $UTILS_PATH/build_kokkos-kernels.sh

      - name: Configure stdBLAS
        run: |
          [[ ${{ matrix.implementation }} == "Kokkos" ]] && ENABLE_KOKKOS=ON
          cmake \
            -S $GITHUB_WORKSPACE/src/stdblas \
            -B $GITHUB_WORKSPACE/build/stdblas \
            -DCMAKE_BUILD_TYPE:STRING=${{ matrix.cmake_build_type }} \
            -DCMAKE_INSTALL_PREFIX:FILEPATH=$GITHUB_WORKSPACE/install \
            -DBUILD_SHARED_LIBS=$SHARED_LIBS \
            -DCMAKE_CXX_STANDARD:STRING=$CXX_STANDARD \
            -DLINALG_ENABLE_TESTS:BOOL=ON \
            -DLINALG_ENABLE_EXAMPLES:BOOL=On \
            -DLINALG_ENABLE_CONCEPTS:BOOL=ON \
            -DLINALG_ENABLE_KOKKOS:BOOL=$ENABLE_KOKKOS \
            -DLINALG_ENABLE_KOKKOS_DEFAULT:BOOL=$ENABLE_KOKKOS

      - name: Build stdBLAS
        run: |
          cmake --build $GITHUB_WORKSPACE/build/stdblas -j $(nproc)

      - name: Test stdBLAS
        working-directory: build/stdblas
        run: ctest -j $(nproc) --timeout 60 --output-on-failure
